{% extends "base.html" %}

{% block title %}Medical System{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-hospital"></i> Medical System</h1>
    <p>Patient records analysis and medical data insights</p>
</div>

{% if data.error %}
<div class="error-box">
    <p>{{ data.error }}</p>
</div>
{% else %}

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <h3>Total Patients</h3>
        <p class="stat-value">{{ data.summary.total_patients }}</p>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-birthday-cake"></i></div>
        <h3>Average Age</h3>
        <p class="stat-value">{{ data.summary.average_age }} years</p>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-heartbeat"></i></div>
        <h3>Avg Systolic BP</h3>
        <p class="stat-value">{{ data.vital_signs_stats.average_systolic_bp }} mmHg</p>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-heart"></i></div>
        <h3>Avg Heart Rate</h3>
        <p class="stat-value">{{ data.vital_signs_stats.average_heart_rate }} bpm</p>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-thermometer-half"></i></div>
        <h3>Avg Temperature</h3>
        <p class="stat-value">{{ data.vital_signs_stats.average_temperature }}°F</p>
    </div>
</div>

<div class="section">
    <h2><i class="fas fa-stethoscope"></i> Diagnosis Distribution</h2>
    <div class="chart-container">
        <canvas id="diagnosisChart"></canvas>
    </div>
    <div class="distribution">
        {% for diagnosis, count in data.diagnosis_distribution.items() %}
        <div class="dist-item">
            <span class="dist-label">{{ diagnosis }}:</span>
            <span class="dist-value">{{ count }} patients</span>
        </div>
        {% endfor %}
    </div>
</div>

<div class="section">
    <h2><i class="fas fa-chart-bar"></i> Age Distribution</h2>
    <div class="chart-container">
        <canvas id="ageChart"></canvas>
    </div>
    <div class="distribution">
        {% for age_group, count in data.age_distribution.items() %}
        <div class="dist-item">
            <span class="dist-label">{{ age_group }}:</span>
            <span class="dist-value">{{ count }} patients</span>
        </div>
        {% endfor %}
    </div>
</div>

<div class="section">
    <h2><i class="fas fa-pills"></i> Medication Usage</h2>
    <div class="chart-container">
        <canvas id="medicationChart"></canvas>
    </div>
    <div class="distribution">
        {% for medication, count in data.medication_usage.items() %}
        <div class="dist-item">
            <span class="dist-label">{{ medication }}:</span>
            <span class="dist-value">{{ count }} patients</span>
        </div>
        {% endfor %}
    </div>
</div>

<div class="section">
    <h2><i class="fas fa-chart-line"></i> Vital Signs Overview</h2>
    <div class="chart-container">
        <canvas id="vitalSignsChart"></canvas>
    </div>
</div>

<div class="section">
    <h2><i class="fas fa-folder-open"></i> All Patient Records</h2>
    <div class="filter-section">
        <input type="text" id="searchInput" placeholder="Search by name, ID, or diagnosis..." class="search-input">
        <select id="diagnosisFilter" class="filter-select">
            <option value="">All Diagnoses</option>
            {% for diagnosis in data.diagnosis_distribution.keys() %}
            <option value="{{ diagnosis }}">{{ diagnosis }}</option>
            {% endfor %}
        </select>
        <select id="ageFilter" class="filter-select">
            <option value="">All Age Groups</option>
            {% for age_group in data.age_distribution.keys() %}
            <option value="{{ age_group }}">{{ age_group }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="patient-cards" id="patientCards">
        {% for patient in data.all_patients %}
        <div class="patient-card" data-name="{{ patient.name|lower }}" data-id="{{ patient.patient_id|lower }}" data-diagnosis="{{ patient.diagnosis }}" data-age-group="{% if patient.age >= 18 and patient.age <= 30 %}18-30{% elif patient.age >= 31 and patient.age <= 45 %}31-45{% elif patient.age >= 46 and patient.age <= 60 %}46-60{% else %}60+{% endif %}">
            <h3>{{ patient.name }} (ID: {{ patient.patient_id }})</h3>
            <div class="patient-info">
                <p><strong>Age:</strong> {{ patient.age }} years</p>
                <p><strong>Diagnosis:</strong> {{ patient.diagnosis }}</p>
                <p><strong>Medications:</strong> {{ patient.medications|join(', ') }}</p>
                <p><strong>Last Visit:</strong> {{ patient.last_visit }}</p>
                <div class="vital-signs">
                    <h4><i class="fas fa-heartbeat"></i> Vital Signs:</h4>
                    <p>Blood Pressure: {{ patient.vital_signs.blood_pressure }}</p>
                    <p>Heart Rate: {{ patient.vital_signs.heart_rate }} bpm</p>
                    <p>Temperature: {{ patient.vital_signs.temperature }}°F</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
    const diagnosisData = {{ data.diagnosis_distribution|tojson }};
    const ageData = {{ data.age_distribution|tojson }};
    const medicationData = {{ data.medication_usage|tojson }};
    const patients = {{ data.all_patients|tojson }};
    
    // Diagnosis Chart
    const diagnosisCtx = document.getElementById('diagnosisChart').getContext('2d');
    new Chart(diagnosisCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(diagnosisData),
            datasets: [{
                label: 'Number of Patients',
                data: Object.values(diagnosisData),
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: '#3498db',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Patients by Diagnosis'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Age Distribution Chart
    const ageCtx = document.getElementById('ageChart').getContext('2d');
    new Chart(ageCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(ageData),
            datasets: [{
                data: Object.values(ageData),
                backgroundColor: [
                    '#3498db',
                    '#2ecc71',
                    '#f39c12',
                    '#e74c3c'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Age Group Distribution'
                }
            }
        }
    });
    
    // Medication Usage Chart
    const medicationCtx = document.getElementById('medicationChart').getContext('2d');
    new Chart(medicationCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(medicationData),
            datasets: [{
                label: 'Number of Patients',
                data: Object.values(medicationData),
                backgroundColor: 'rgba(155, 89, 182, 0.7)',
                borderColor: '#9b59b6',
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Medication Usage'
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Vital Signs Chart
    const vitalCtx = document.getElementById('vitalSignsChart').getContext('2d');
    const bpValues = patients.map(p => parseInt(p.vital_signs.blood_pressure.split('/')[0]) || 0);
    const hrValues = patients.map(p => p.vital_signs.heart_rate || 0);
    const tempValues = patients.map(p => p.vital_signs.temperature || 0);
    
    new Chart(vitalCtx, {
        type: 'line',
        data: {
            labels: patients.map(p => p.name),
            datasets: [
                {
                    label: 'Systolic BP',
                    data: bpValues,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4
                },
                {
                    label: 'Heart Rate (bpm)',
                    data: hrValues,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4
                },
                {
                    label: 'Temperature (°F)',
                    data: tempValues,
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    yAxisID: 'y2',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Vital Signs by Patient'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Systolic BP (mmHg)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Heart Rate (bpm)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                },
                y2: {
                    type: 'linear',
                    display: false,
                }
            }
        }
    });
    
    // Search and Filter
    const searchInput = document.getElementById('searchInput');
    const diagnosisFilter = document.getElementById('diagnosisFilter');
    const ageFilter = document.getElementById('ageFilter');
    const patientCards = document.getElementById('patientCards');
    const cards = patientCards.querySelectorAll('.patient-card');
    
    function filterPatients() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedDiagnosis = diagnosisFilter.value;
        const selectedAgeGroup = ageFilter.value;
        
        cards.forEach(card => {
            const name = card.getAttribute('data-name');
            const id = card.getAttribute('data-id');
            const diagnosis = card.getAttribute('data-diagnosis');
            const ageGroup = card.getAttribute('data-age-group');
            
            const matchesSearch = !searchTerm || 
                name.includes(searchTerm) || 
                id.includes(searchTerm) ||
                diagnosis.toLowerCase().includes(searchTerm);
            const matchesDiagnosis = !selectedDiagnosis || diagnosis === selectedDiagnosis;
            const matchesAge = !selectedAgeGroup || ageGroup === selectedAgeGroup;
            
            if (matchesSearch && matchesDiagnosis && matchesAge) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    searchInput.addEventListener('input', filterPatients);
    diagnosisFilter.addEventListener('change', filterPatients);
    ageFilter.addEventListener('change', filterPatients);
</script>
{% endblock %}

